{#- Macros for rendering different content types in markdown -#}

{#- Extract filename from path -#}
{% macro filename(path) -%}
{{ path.split('/')[-1] if '/' in path else path }}
{%- endmacro %}

{#- Render a thinking block as blockquote -#}
{% macro thinking(content) -%}
**ðŸ’­ Thinking**

> {{ content | replace('\n', '\n> ') }}
{%- endmacro %}

{#- Render a todo list with checkboxes -#}
{% macro todo_list(todos) -%}
{% for todo in todos -%}
{% if todo.status == 'completed' -%}
- [x] {{ todo.content }}
{% elif todo.status == 'in_progress' -%}
- [ ] {{ todo.content }} *(in progress)*
{% else -%}
- [ ] {{ todo.content }}
{% endif -%}
{% endfor -%}
{%- endmacro %}

{#- Render a Write tool call -#}
{% macro write_tool(file_path, content) -%}
**Write** `{{ filename(file_path) }}`
<details>
<summary>{{ file_path }}</summary>

{{ content | fence_for }}
{{ content }}
{{ content | fence_for }}

</details>
{%- endmacro %}

{#- Render an Edit tool call -#}
{% macro edit_tool(file_path, old_string, new_string, replace_all) -%}
{%- set diff_content = '- ' ~ (old_string | replace('\n', '\n- ')) ~ '\n+ ' ~ (new_string | replace('\n', '\n+ ')) -%}
**Edit** `{{ filename(file_path) }}`{% if replace_all %} *(replace all)*{% endif %}

<details>
<summary>{{ file_path }}</summary>

{{ diff_content | fence_for }}diff
{{ diff_content }}
{{ diff_content | fence_for }}

</details>
{%- endmacro %}

{#- Render a Read tool call -#}
{% macro read_tool(file_path) -%}
**Read** `{{ filename(file_path) }}`
<details>
<summary>{{ file_path }}</summary>
</details>
{%- endmacro %}

{#- Render a Bash tool call -#}
{% macro bash_tool(command, description) -%}
{% if description -%}
**Bash**: {{ description }}
{% else -%}
**Bash**
{% endif %}
{{ command | fence_for }}bash
{{ command }}
{{ command | fence_for }}
{%- endmacro %}

{#- Render a generic tool call -#}
{% macro tool_use(tool_name, description, input_json) -%}
**{{ tool_name }}**{% if description %}: {{ description }}{% endif %}

{{ input_json | fence_for }}json
{{ input_json }}
{{ input_json | fence_for }}
{%- endmacro %}

{#- Render a tool result -#}
{% macro tool_result(content, is_error) -%}
{% if is_error -%}
> âš ï¸ **Error**
{% endif -%}
{{ content | fence_for }}
{{ content }}
{{ content | fence_for }}
{%- endmacro %}

{#- Render a commit -#}
{% macro commit(hash, message, github_repo) -%}
{% if github_repo -%}
[`{{ hash[:7] }}`](https://github.com/{{ github_repo }}/commit/{{ hash }}) {{ message }}
{%- else -%}
`{{ hash[:7] }}` {{ message }}
{%- endif %}
{%- endmacro %}

{#- Create a header from text (first X words) -#}
{% macro text_header(text, max_words=6) -%}
{%- set words = text.split()[:max_words] -%}
{%- set header = words | join(' ') -%}
{%- if text.split() | length > max_words -%}
{{ header }}...
{%- else -%}
{{ header }}
{%- endif -%}
{%- endmacro %}

{#- Long text threshold (characters) -#}
{%- set LONG_TEXT_THRESHOLD = 300 -%}

{#- Main template starts here -#}
# Claude Code Transcript

{% for conversation in conversations -%}
{% if not conversation.is_continuation -%}
## {{ text_header(conversation.user_text) }}

{% endif -%}
{% for message in conversation.messages -%}
{% if message.role == 'user' and message.is_prompt -%}
**User**: {{ message.content }}

{% elif message.role == 'user' and message.is_tool_result -%}
{% for block in message.blocks -%}
{% if block.type == 'tool_result' -%}
{{ tool_result(block.content, block.is_error) }}

{% endif -%}
{% endfor -%}
{% elif message.role == 'assistant' -%}
{#- Check if this assistant message has long text content -#}
{%- set long_text = namespace(content='') -%}
{%- for block in message.blocks -%}
{%- if block.type == 'text' and block.text | length >= LONG_TEXT_THRESHOLD -%}
{%- set long_text.content = block.text -%}
{%- endif -%}
{%- endfor -%}
{%- if long_text.content -%}
### {{ text_header(long_text.content) }}

{% endif -%}
{% for block in message.blocks -%}
{% if block.type == 'thinking' -%}
{{ thinking(block.thinking) }}

{% elif block.type == 'text' -%}
{{ block.text }}

{% elif block.type == 'tool_use' -%}
{% if block.name == 'TodoWrite' -%}
{{ todo_list(block.input.todos) }}

{% elif block.name == 'Write' -%}
{{ write_tool(block.input.file_path, block.input.content) }}

{% elif block.name == 'Edit' -%}
{{ edit_tool(block.input.file_path, block.input.old_string, block.input.new_string, block.input.replace_all | default(false)) }}

{% elif block.name == 'Bash' -%}
{{ bash_tool(block.input.command, block.input.description | default('')) }}

{% elif block.name == 'Read' -%}
{{ read_tool(block.input.file_path) }}

{% else -%}
{{ tool_use(block.name, block.input.description | default(''), block.input_json) }}

{% endif -%}
{% endif -%}
{% endfor -%}
{% endif -%}
{% endfor -%}
{% endfor -%}
